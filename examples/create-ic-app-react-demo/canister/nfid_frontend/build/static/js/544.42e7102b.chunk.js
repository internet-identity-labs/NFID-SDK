"use strict";(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([[544],{83851:(e,t,n)=>{n.r(t),n.d(t,{default:()=>D});var a=n(64279),o=n(87273),s=n(8439),i=n(82898),r=n(13791),c=n(54915),l=n(96349),u=n(94480),d=n(7863),p=n(75557),m=n(42809),v=n(23210),f=n(8708),h=n(69491),g=n(94244),x=n(36516),b=n(25390);const I=async e=>{let{to:t,amount:n,delegationIdentity:a,transformAmount:o,canisterId:s}=e;return s?await(0,f.re)({canisterId:s,amount:o(n),to:t,sourceIdentity:a}):await(0,d.re)(o(n),t,a)},T=e=>{let{domain:t,accountId:n,tokenCanisterId:a,transformAmount:s}=e;const{profile:i}=(0,h.Un)(),{data:r,isValidating:c}=(l=null===i||void 0===i?void 0:i.anchor,u=t,d=n,console.debug("useWalletDelegation",{userNumber:l}),(0,g.ZP)(l?[l,u,d]:null,(e=>{let[t,n,a]=e;return(0,b.p)(t,n,a)}),{dedupingInterval:x.CP/2,focusThrottleInterval:x.CP/2}));var l,u,d;const p=o.useRef(null);o.useEffect((()=>{var e,a,o;(null===(e=p.current)||void 0===e?void 0:e.domain)===t&&(null===(a=p.current)||void 0===a?void 0:a.accountId)===n||((null===(o=p.current)||void 0===o?void 0:o.rejectTransfer)&&p.current.rejectTransfer("domain or accountId has been changed"),p.current=null)}),[t,n]),o.useEffect((()=>{if(p.current){const{amount:e,to:a,executeTransfer:o,domain:s,accountId:i}=p.current;r&&o&&s===t&&i===n&&(o(r,a,e),p.current=null)}}),[n,t,r]);const m=o.useCallback((async(e,o)=>{if(p.current)throw new Error("there is a pending transfer");return new Promise(((i,c)=>{if(r)return I({amount:o,to:e,delegationIdentity:r,canisterId:a,transformAmount:s}).then((e=>i(e))).catch((e=>c(e)));p.current={to:e,amount:o,domain:t,accountId:n,rejectTransfer:c,executeTransfer:(e,t,n)=>{I({amount:n,to:t,delegationIdentity:e,canisterId:a,transformAmount:s}).then((e=>i(e))).catch((e=>c(e)))}}}))}),[n,t,a,s,r]);return console.debug("useTransfer",{isValidatingWalletDelegation:c}),{isValidatingWalletDelegation:c,transfer:m}};var C=n(51921),N=n(18414),y=n(55137),R=n(33693);const k=e=>{let{applicationName:t,applicationLogo:n,amountICP:a,amountUSD:o,walletOptions:s,selectedWallets:r,setSelectedWallets:c,onReject:l,onApprove:u,isLoading:p=!1,destinationAddress:m,successTimer:v,isInsufficientFunds:f}=e;return(0,R.jsxs)(i.D1,{applicationName:t,applicationLogo:n,onReject:l,onApprove:f?()=>{}:u,isLoading:p,successTimer:v,children:[(0,R.jsx)(i.s0,{isLoading:p,isSuccess:-1!==v,children:(0,R.jsxs)("div",{className:"flex items-center justify-between w-full",children:[(0,R.jsx)("p",{className:"text-sm font-semibold",children:"Transfer"}),(0,R.jsxs)("p",{className:"text-sm",children:[a," ICP ",(0,R.jsxs)("span",{className:"text-xs text-secondary",children:["\u2248 ",o," "]})]})]})}),(0,R.jsx)("p",{className:"mb-1 text-sm",children:"From"}),(0,R.jsx)(i.TV,{disabled:p||-1!==v,isSearch:!0,isMultiselect:!1,options:s,selectedValues:r,setSelectedValues:c,firstSelected:!0,errorText:f?"Insufficient funds":void 0}),(0,R.jsx)("p",{className:"mt-2 mb-1 text-sm",children:"To"}),(0,R.jsxs)("div",{className:(0,N.Z)("h-10 text-secondary bg-gray-100 rounded-md","flex items-center justify-between px-2.5 space-x-2"),id:"account-id",children:[(0,R.jsx)("p",{className:"overflow-hidden text-sm text-ellipsis whitespace-nowrap",children:m}),(0,R.jsx)(y.C,{className:"w-[18px] h-[18px] flex-shrink-0",value:m})]}),(0,R.jsxs)("div",{className:"text-xs text-secondary mt-2.5",children:["Transfer fee: ",d.X_," ICP"]})]})};var w=n(27221);const j=e=>{let{amountICP:t,applicationLogo:n,applicationName:a,onSuccess:s,to:i}=e;const[f,h]=(0,o.useState)([]),[g,x]=(0,o.useState)(!1),{counter:b,setCounter:I}=(0,w.J)({defaultCounter:-1}),{wallets:N}=(0,v.w)(),{exchangeRate:y}=(0,m.G)(),j=(0,o.useMemo)((()=>null===N||void 0===N?void 0:N.find((e=>e.principal.toString()===f[0]))),[f,N]),{transfer:A}=T({accountId:null===j||void 0===j?void 0:j.accountId,domain:null===j||void 0===j?void 0:j.domain,transformAmount:C.Q}),S=(0,o.useMemo)((()=>{var e;return null===N||void 0===N||null===(e=N.filter((e=>!e.isVaultWallet)))||void 0===e?void 0:e.map((e=>{var n,a,o;return{label:null!==(n=e.label)&&void 0!==n?n:"",value:null!==(a=null===(o=e.principal)||void 0===o?void 0:o.toText())&&void 0!==a?a:"",afterLabel:(0,d.T9)(e.balance.ICP),disabled:Number(e.balance)<=Number(t)}})).sort(((e,t)=>Number(null===e||void 0===e?void 0:e.disabled)-Number(null===t||void 0===t?void 0:t.disabled)))}),[t,N]),P=(0,o.useMemo)((()=>y?(0,p.tF)(t,y):"0"),[t,y]),B=(0,o.useMemo)((()=>!(null===S||void 0===S||!S.length)&&!(null!==S&&void 0!==S&&S.filter((e=>!0!==e.disabled)).length)),[S]);return(0,R.jsx)(k,{amountICP:t,amountUSD:P,walletOptions:null!==S&&void 0!==S?S:[],selectedWallets:f,setSelectedWallets:h,onReject:()=>window.close(),onApprove:async()=>{let e=(0,u.v)(i)?i:(0,c.PZ)(r.Principal.fromText(i));try{x(!0);const n=await A(e,String(t));I(5),setTimeout((()=>s(n)),5e3)}catch(n){"InsufficientFunds"===n.message?l.Am.error("You don't have enough ICP for this transaction",{toastId:"insufficientFundsError"}):l.Am.error("Unexpected error: The transaction has been cancelled",{toastId:"unexpectedTransferError"})}finally{x(!1)}},isLoading:g,applicationLogo:null!==n&&void 0!==n?n:"",applicationName:null!==a&&void 0!==a?a:"",destinationAddress:i,successTimer:b,isInsufficientFunds:B})};var A=n(53844),S=n(84732),P=n(20663),B=n(29323);let E=null;const q=(0,A.C)({context:{},tsTypes:{},schema:{events:{}},id:"RequestTransferProvider",initial:"Ready",states:{Ready:{invoke:{src:"registerRequestTransferHandler",id:"registerRequestTransferHandler",onDone:{target:"Authenticate",actions:"assignRequestTransferRequest"}}},Authenticate:{invoke:{src:"AuthenticationMachine",id:"AuthenticationMachine",onDone:[{target:"RequestTransfer",actions:"assignAuthSession"}],data:e=>({appMeta:e.appMeta})}},RequestTransfer:{on:{CONFIRM:{target:"Confirm",actions:"assignBlockHeight"}}},Confirm:{onEntry:"setBlockHeight"},End:{type:"final"}}},{actions:{assignAuthSession:(0,S.f0)(((e,t)=>({authSession:t.data}))),assignRequestTransferRequest:(0,S.f0)({requestTransfer:(e,t)=>t.data}),setBlockHeight:e=>{let{blockHeight:t}=e;E=Number(t)},assignBlockHeight:(0,S.f0)({blockHeight:(e,t)=>t.blockHeight})},services:{async registerRequestTransferHandler(){const e=await(0,P.registerRequestTransferHandler)((()=>new Promise((e=>{setInterval((()=>{E&&e({status:"SUCCESS",height:E})}),1e3)}))));return console.debug("registerRequestTransferHandler",{params:e}),e},AuthenticationMachine:B.Z},guards:{}});var M=n(93302),L=n(8880);function D(e){var t,n,r,c,l,u,d,p;let{machine:m}=e;const[v]=(0,s.lr)(),f=v.get("applicationName"),h=v.get("applicationLogo"),[g,x]=(0,a.e)(m||q.withConfig({},{appMeta:{name:f||"",logo:h||""}}));switch((0,o.useEffect)((()=>{console.debug("RequestTransferCoordinator",{state:g.value})}),[g]),!0){case g.matches("Ready"):return(0,R.jsx)(M.B,{isLoading:!0,loadingMessage:`Connecting to ${null!==(t=null===(n=g.context.appMeta)||void 0===n?void 0:n.name)&&void 0!==t?t:"the application"}`});case g.matches("Authenticate"):return(0,R.jsx)(i.$$,{children:(0,R.jsx)(L.d,{actor:g.children.AuthenticationMachine,enforceSingleAccountScreen:!0})});case g.matches("RequestTransfer"):return(0,R.jsx)(j,{applicationName:null!==(r=v.get("applicationName"))&&void 0!==r?r:"",applicationLogo:null!==(c=v.get("applicationLogo"))&&void 0!==c?c:"",to:null!==(l=null===(u=g.context.requestTransfer)||void 0===u?void 0:u.to)&&void 0!==l?l:"",amountICP:null!==(d=null===(p=g.context.requestTransfer)||void 0===p?void 0:p.amount)&&void 0!==d?d:0,onSuccess:e=>{x({type:"CONFIRM",blockHeight:e})}});default:return console.debug(`PhoneCredentialCoordinator rendering loader, unknown state: ${JSON.stringify(g.value)}`),(0,R.jsx)(M.B,{isLoading:!0})}}},75557:(e,t,n)=>{n.d(t,{RJ:()=>c,tF:()=>i});var a=n(13791),o=n(54915);const s=e=>/^Account #\d*$/.test(e)||void 0===e||""===e;n(51921);const i=(e,t)=>0!==t?`$${(t*e).toFixed(2)}`:"";function r(e){var t;let{toPresentation:n,appName:r,currentAppTotalBalance:c,token:l,accountBalance:u,exchangeRate:d,applicationMatch:p,currentApp:m,isExplicitlyIncluded:v}=e;return{icon:null===p||void 0===p?void 0:p.icon,appName:r,tokenBalance:c,accounts:[...null!==(t=null===m||void 0===m?void 0:m.accounts)&&void 0!==t?t:[],...u.balance[l]>0||v?[{accountName:s(u.account.label)||!u.account.label?`account ${parseInt(u.account.accountId)+1}`:u.account.label,principalId:u.principalId,address:(0,o.PZ)(a.Principal.fromText(u.principalId)),tokenBalance:u.balance[l],usdBalance:i(n(u.balance[l]),d)}]:[]].sort(((e,t)=>e.accountName.localeCompare(t.accountName)))}}const c=e=>{let{toPresentation:t,balances:n,applications:a=[],exchangeRate:o,excludeEmpty:s,includeEmptyApps:c,label:l,token:u,icon:d}=e;return n.reduce(((e,n)=>{var l;const u=a.find((e=>e.domain===n.account.domain)),d=u?u.name:n.account.domain,p=e.applications[d],m=e.tokenBalance+n.balance[e.token],v=((null===(l=e.applications[d])||void 0===l?void 0:l.tokenBalance)||BigInt(0))+n.balance[e.token],f=c.includes((null===u||void 0===u?void 0:u.domain)||"")||c.includes((null===u||void 0===u?void 0:u.name)||"");return s&&!f&&v===BigInt(0)?e:{...e,icon:e.icon,tokenBalance:m,usdBalance:i(t(m),o),applications:{...e.applications,[d]:r({toPresentation:t,appName:d,currentAppTotalBalance:v,token:e.token,accountBalance:n,exchangeRate:o,applicationMatch:u,currentApp:p,isExplicitlyIncluded:f})}}}),{label:l,token:u,icon:d,tokenBalance:BigInt(0),usdBalance:"0",applications:{}})}},42809:(e,t,n)=>{n.d(t,{G:()=>l});var a,o=n(94244),s=n(78765);const i=`https://free.currconv.com/api/v7/convert?q=XDR_USD&compact=ultra&apiKey=${null!==(a=CURRCONV_TOKEN)&&void 0!==a?a:"df6440fc0578491bb13eb2088c4f60c7"}`;async function r(e){return e.json().then((e=>e))}async function c(){let e=await s.Ds.get_icp_xdr_conversion_rate().then((e=>e.data.xdr_permyriad_per_icp)).catch((e=>{throw Error(`CyclesMinter failed!: ${e}`,e)})),t=await(0,s.L8)("GET",i).then(r).catch((e=>{throw Error(`free.currconv.com failed!: ${e}`,e)}));return parseFloat(t.XDR_USD)*Number(e)/1e4}const l=()=>{const{data:e,...t}=(0,o.ZP)("walletExchangeRate",c,{dedupingInterval:36e5,focusThrottleInterval:36e5,refreshInterval:36e5});return{exchangeRate:e,...t}}},55137:(e,t,n)=>{n.d(t,{C:()=>l});var a=n(18414),o=n(87273),s=n(82898);const i=n.p+"static/media/copied.7db236d4ed9a8d82463d41f442395067.svg";const r=n.p+"static/media/copy.fa74bb78f3023163889b69dafbaee228.svg";var c=n(33693);const l=e=>{let{value:t,className:n}=e;const[l,u]=o.useState(!1),d=o.useCallback((()=>{u(!0),navigator.clipboard.writeText(t),setTimeout((()=>{u(!1)}),2e3)}),[t]);return(0,c.jsx)("div",{className:(0,a.Z)(!l&&"hover:opacity-50 cursor-pointer transition-opacity",n),children:(0,c.jsx)(s.u,{tip:"Copy",children:(0,c.jsx)(s.Ee,{className:"w-full",onClick:d,src:l?i:r,alt:"copy"})})})}},27221:(e,t,n)=>{n.d(t,{J:()=>o});var a=n(87273);const o=e=>{let{defaultCounter:t,loop:n,frequency:o=1e3,onElapsed:s}=e;const[i,r]=a.useState(t),c=a.useRef(),[l,u]=a.useState(!1),d=a.useCallback((()=>{i>0&&r(i-1),0===i&&(u(!0),s&&s(),clearInterval(Number(c.current))),0===i&&n&&(r(t),c.current=setInterval(d,o),u(!1))}),[i,t,o,n,s]);return a.useEffect((()=>(c.current=setInterval(d,o),()=>clearInterval(Number(c.current)))),[o,d]),{elapsed:l,setCounter:r,counter:i}}}}]);
//# sourceMappingURL=544.42e7102b.chunk.js.map