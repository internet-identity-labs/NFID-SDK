"use strict";(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([[75],{13485:(e,t,i)=>{i.d(t,{Z:()=>n});i(87273);const n=i.p+"static/media/dfinity.583ab84ba16070ca501453d1e291dff4.svg"},43317:(e,t,i)=>{i.r(t),i.d(t,{default:()=>k});var n=i(64279),a=i(87273),o=i(53844),r=i(84732),s=i(71287),c=i(18392),l=i(29323),u=i(67841),d=i(71516),h=i(62014);const g=(0,o.C)({tsTypes:{},schema:{events:{},context:{}},id:"authorize",initial:"Start",states:{Start:{invoke:{src:"fetchAccountLimitService",id:"fetchAccountLimitService",onDone:[{actions:"assignUserLimit",target:"FetchAccounts"}]}},FetchAccounts:{invoke:{src:"fetchAccountsService",id:"fetchAccountsService",onDone:[{actions:["assignAccounts","handleAccounts"]}]},on:{CREATE_ACCOUNT:"CreateAccount",SELECT_ACCOUNT:"GetDelegation",PRESENT_ACCOUNTS:"PresentAccounts"}},CreateAccount:{invoke:{src:"createAccountService",id:"createAccountService",onDone:[{target:"GetDelegation"}]}},PresentAccounts:{on:{SELECT_ACCOUNT:{target:"GetDelegation"},CREATE_ACCOUNT:"CreateAccount"}},GetDelegation:{invoke:{src:"fetchDelegateService",id:"fetchDelegateService",onDone:"End",onError:"PresentAccounts"}},End:{type:"final",data:(e,t)=>t.data}}},{actions:{assignUserLimit:(0,r.f0)({accountsLimit:(e,t)=>t.data}),assignAccounts:(0,r.f0)({accounts:(e,t)=>t.data}),handleAccounts:(0,r.lW)(((e,t)=>{var i,n,a;return{type:(n=t.data.length,a=e.accountsLimit,console.debug("selectAccountAction",{accountsAmount:n,accountsLimit:a}),0===n?(console.debug("selectAccountAction CREATE_ACCOUNT"),"CREATE_ACCOUNT"):a&&a<=1?(console.debug("selectAccountAction SELECT_ACCOUNT"),"SELECT_ACCOUNT"):(console.debug("selectAccountAction PRESENT_ACCOUNTS"),"PRESENT_ACCOUNTS")),data:null===(i=t.data[0])||void 0===i?void 0:i.accountId}}))},services:{fetchAccountLimitService:u.s,fetchAccountsService:d.r6,fetchDelegateService:h.SQ,createAccountService:d.ae}});var v=i(53131);const m=(0,o.C)({tsTypes:{},schema:{events:{},context:{isIframe:!1}},id:"idp",initial:"Start",states:{Start:{type:"parallel",states:{Handshake:{initial:"Fetch",states:{Fetch:{invoke:{src:"handshake",id:"handshake",onDone:[{actions:"assignAuthRequest",target:"CheckIsIframe"}],onError:{target:"Error",actions:"assignError"}}},CheckIsIframe:{invoke:{src:"checkIsIframe",id:"checkIsIframe",onDone:[{actions:"assignIsIframe",target:"CheckIsIframeAllowed",cond:"isTrue"},{target:"#idp.AuthenticationMachine"}]}},CheckIsIframeAllowed:{invoke:{src:"checkIsIframeAllowed",id:"checkIsIframeAllowed",onDone:[{target:"#idp.AuthenticationMachine",cond:"isTrue"},{target:"Error",actions:"assignIframeNotAllowedError"}]}},Error:{on:{RETRY:"Fetch"}},Done:{type:"final"}}},GetAppMeta:{initial:"Fetch",states:{Fetch:{invoke:{src:"getAppMeta",id:"getAppMeta",onDone:[{actions:"assignAppMeta",target:"Done"}]}},Done:{type:"final"}}}},onDone:{target:"AuthenticationMachine"}},AuthenticationMachine:{invoke:{src:"AuthenticationMachine",id:"authenticate",onDone:"AuthorizationMachine",data:e=>({appMeta:e.appMeta,authRequest:e.authRequest})}},AuthorizationMachine:{invoke:{src:"AuthorizationMachine",id:"authorize",onDone:[{target:"TrustDevice",cond:"isWebAuthNSupported"},{target:"End"}],data:(e,t)=>({appMeta:e.appMeta,authRequest:e.authRequest,authSession:t.data})}},TrustDevice:{entry:"assignAuthoSession",invoke:{src:"TrustDeviceMachine",id:"trustDeviceMachine",onDone:"End",data:e=>({isIframe:e.isIframe})}},End:{invoke:{src:"postDelegation",id:"postDelegation"},type:"final"},Error:{type:"final"}}},{services:{handshake:c.YN,getAppMeta:c.nt,postDelegation:c.ss,checkIsIframe:c.gn,checkIsIframeAllowed:c.qN,AuthenticationMachine:l.Z,AuthorizationMachine:g,TrustDeviceMachine:v.Z},actions:{assignAuthRequest:(0,r.f0)(((e,t)=>({authRequest:t.data}))),assignAppMeta:(0,r.f0)(((e,t)=>({appMeta:t.data}))),assignAuthoSession:(0,r.f0)({thirdPartyAuthoSession:(e,t)=>t.data}),assignError:(0,r.f0)({error:(e,t)=>t.data}),assignIframeNotAllowedError:(0,r.f0)({error:e=>new Error("NFID Embed is not activated. Please contact Internet Identity Labs at support@identitylabs.ooo to activate this feature.")}),assignIsIframe:(0,r.f0)(((e,t)=>({isIframe:t.data})))},guards:{isWebAuthNSupported:s.AL,isTrue:(e,t)=>!!t.data}});var p=i(93302),f=i(82898),y=i(33693);const A=e=>{let{errorMessage:t,onRetry:i}=e;return(0,y.jsxs)("div",{className:"flex flex-col space-y-4",children:[(0,y.jsx)("div",{className:"rounded bg-red-200 p-8 text-sm",children:(0,y.jsxs)("div",{className:"flex center",children:[(0,y.jsx)("div",{className:"mr-2",children:(0,y.jsx)(f.tG,{})}),(0,y.jsx)("div",{className:"text-sm opacity-40",children:t})]})}),(0,y.jsx)(f.zx,{type:"primary",onClick:i,children:"Retry"})]})};var w=i(8880),b=i(55081),S=i(23439),C=i(26894),D=i(62963);function T(e){var t,i,n,o,r,s;let{actor:c}=e;const[l,u]=(0,b.L)(c);a.useEffect((()=>{console.debug("AuthorizationCoordinator",{context:l.context,state:l.value})}),[l.context,l.value]);const d=a.useMemo((()=>{var e,t,i,n,a,o;return(l.matches("FetchAccounts")||l.matches("Start"))&&`Loading your ${null!==(e=null===(t=l.context.appMeta)||void 0===t?void 0:t.name)&&void 0!==e?e:""} accounts `||l.matches("CreateAccount")&&`Creating your ${null!==(i=null===(n=l.context.appMeta)||void 0===n?void 0:n.name)&&void 0!==i?i:""} account`||l.matches("GetDelegation")&&`Signing in to ${null!==(a=null===(o=l.context.appMeta)||void 0===o?void 0:o.name)&&void 0!==a?a:"the application"}`}),[l]);switch(!0){case l.matches("Start"):case l.matches("PresentAccounts"):case l.matches("FetchAccounts"):case l.matches("CreateAccount"):case l.matches("GetDelegation"):return 1===l.context.accountsLimit?(0,y.jsx)(D.$,{applicationName:null===(t=l.context.appMeta)||void 0===t?void 0:t.name,applicationLogo:null===(i=l.context.appMeta)||void 0===i?void 0:i.logo,isLoading:l.matches("Start")||l.matches("FetchAccounts")||l.matches("CreateAccount")||l.matches("GetDelegation"),loadingMessage:d,onContinueButtonClick:function(){throw new Error("AuthorizationCoordinator onContinueButtonClick not implemented.")}}):(0,y.jsx)(C.t,{isAuthenticated:!0,applicationName:null===(n=l.context.appMeta)||void 0===n?void 0:n.name,applicationLogo:null===(o=l.context.appMeta)||void 0===o?void 0:o.logo,accountsLimit:l.context.accountsLimit,isLoading:l.matches("Start")||l.matches("FetchAccounts")||l.matches("CreateAccount")||l.matches("GetDelegation"),loadingMessage:d,accounts:(null===(r=l.context)||void 0===r||null===(s=r.accounts)||void 0===s?void 0:s.map(S.TQ))||[],onLogin:async e=>u({type:"SELECT_ACCOUNT",data:{accountId:e}}),onUnlockNFID:function(){throw new Error("AuthorizationCoordinator onUnlockNFID not implemented.")},onCreateAccount:async()=>u("CREATE_ACCOUNT")});default:return(0,y.jsx)(p.B,{isLoading:!0})}}var x=i(53985);function k(e){var t;let{machine:i}=e;const[o,r]=(0,n.e)(i||m);switch(a.useEffect((()=>console.debug("IDPCoordinator",{context:o.context,state:o.value})),[o.value,o.context]),!0){case o.matches("Start.Handshake.Error"):return(0,y.jsx)(A,{errorMessage:null===(t=o.context.error)||void 0===t?void 0:t.message,onRetry:()=>r("RETRY")});case o.matches("AuthenticationMachine"):return(0,y.jsx)(w.d,{actor:o.children.authenticate});case o.matches("AuthorizationMachine"):return(0,y.jsx)(T,{actor:o.children.authorize});case o.matches("TrustDevice"):return(0,y.jsx)(x.u,{actor:o.children.trustDeviceMachine});case o.matches("End"):case o.matches("Start"):default:return(0,y.jsx)(p.B,{isLoading:!0})}}},53985:(e,t,i)=>{i.d(t,{u:()=>c});var n=i(55081),a=i(87273),o=i(71287),r=i(67142),s=i(33693);function c(e){let{actor:t}=e;const[i,c]=(0,n.L)(t),{hasPlatformAuthenticator:l,platform:u}=(0,o.uw)();return a.useEffect((()=>console.debug("TrustDeviceCoordinator",{context:i.context,state:i.value})),[i.value,i.context]),(0,s.jsx)(r.J,{onLogin:()=>c("DONT_TRUST"),onRegisterPlatformDevice:async()=>c("TRUST"),onRegisterSecurityDevice:async()=>c("TRUST"),isLoading:!i.matches("Select"),loadingMessage:i.matches("Select")?void 0:"registering device",isPlatformAuthenticatorAvailable:!!l,deviceName:u.device,platformAuthenticatorName:u.authenticator})}},18392:(e,t,i)=>{i.d(t,{gn:()=>f,qN:()=>y,nt:()=>p,YN:()=>v,ss:()=>m});var n=i(54915),a=i(18351),o=i(30365),r=i(78765);const s=async e=>{let{scope:t,anchor:i,applicationName:s="Undefined application",chain:c="Internet Computer"}=e;const l=await(0,o.JU)(i,t),u=l.toString();!async function(e){const t=r.ic.isLocal?"/auth":AWS_AUTH_STATS,i=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!i.ok)throw new Error(await i.text())}({application:s,billable:(0,a.g)(),blockchainAddress:(0,n.PZ)(l),chain:c,principal:u})};var c=i(76716);function l(){const e=window.opener||window.parent;if(!e)throw new Error("Could not identify window opener.");return e}function u(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"*";const i=l();console.debug("postMessageToClient",{event:e,hostname:t}),i.postMessage(e,t)}const d=e=>{const t=e.data;if(console.debug("isIdentityClientAuthEvent",{msg:t}),"object"!==typeof t)return!1;if(null===t)return!1;const i=t;if(!(0,c.n)(i,"kind")||"authorize-client"!==i.kind)return!1;if(!(0,c.n)(i,"sessionPublicKey")||!(i.sessionPublicKey instanceof Uint8Array))return!1;const n=i.maxTimeToLive;if("undefined"!==typeof n&&"bigint"!==typeof n)return!1;const a=i.derivationOrigin;return"undefined"===typeof a||"string"===typeof a};var h=i(23439),g=i(13791);async function v(){const e=setInterval((()=>u({kind:"authorize-ready"})),500),t=(i=d,new Promise((e=>{window.addEventListener("message",(t=>{if(i(t))return e(t);console.warn(`awaitClientMessage: Unexpected message: ${JSON.stringify(t)}`)}))}))).then((async t=>{console.debug("handshake",{event:t});const i=await(async(e,t)=>{if(void 0===t||t===e)return{result:"valid"};const i=/^https:\/\/([\w-]*)(\.raw)?\.ic0\.app$/.exec(t);if(null===i)return{result:"invalid",message:'derivationOrigin does not match regex "^https:\\/\\/([\\w-]*)(\\.raw)?\\.ic0\\.app$"'};try{const t=`https://${g.Principal.fromText(i[1]).toText()}.ic0.app/.well-known/ii-alternative-origins`,n=await fetch(t,{redirect:"error"});if(200!==n.status)return{result:"invalid",message:`resource ${t} returned invalid status: ${n.status}`};const a=await n.json();if(console.log(">> ",{alternativeOriginsObj:a}),!Array.isArray(null===a||void 0===a?void 0:a.alternativeOrigins))return{result:"invalid",message:`resource ${t} has invalid format: received ${a}`};if(a.alternativeOrigins.length>10)return{result:"invalid",message:`Resource ${t} has too many entries: To prevent misuse at most 10 alternative origins are allowed.`};if(!a.alternativeOrigins.includes(e))return{result:"invalid",message:`"${e}" is not listed in the list of allowed alternative origins. Allowed alternative origins: ${a.alternativeOrigins}`}}catch(n){return{result:"invalid",message:`An error occurred while validating the derivationOrigin "${t}" for alias domain "${e}": ${null===n||void 0===n?void 0:n.message}`}}return{result:"valid"}})(t.origin,t.data.derivationOrigin);if(console.debug("handshake",{validation:i,derivationOrigin:t.data.derivationOrigin}),"valid"!==i.result)throw new Error(i.message);return clearInterval(e),{maxTimeToLive:t.data.maxTimeToLive,sessionPublicKey:t.data.sessionPublicKey,derivationOrigin:t.data.derivationOrigin,hostname:t.origin}}));var i;return u({kind:"authorize-ready"}),t}async function m(e){var t;if(console.debug("postDelegation"),null===(t=e.authRequest)||void 0===t||!t.hostname)throw new Error("postDelegation context.authRequest.hostname missing");if(!e.thirdPartyAuthoSession)throw new Error("postDelegation context.thirdPartyAuthoSession missing");if(!e.appMeta)throw new Error("postDelegation context.appMeta missing");const i=[(n=e.thirdPartyAuthoSession.signedDelegation,{delegation:{pubkey:Uint8Array.from(n.delegation.pubkey),expiration:n.delegation.expiration,targets:void 0},signature:Uint8Array.from(n.signature)})];var n;const a=e.thirdPartyAuthoSession.userPublicKey;s({scope:e.thirdPartyAuthoSession.scope,anchor:e.thirdPartyAuthoSession.anchor,applicationName:e.appMeta.name,chain:"Internet Computer"}),u({kind:"authorize-client-success",delegations:i,userPublicKey:a},e.authRequest.hostname),window.close()}async function p(){return function(){const e=new URLSearchParams(window.location.search);return{name:e.get("applicationName")||void 0,logo:e.get("applicationLogo")||void 0}}()}async function f(){try{return window.self!==window.top}catch(e){return!0}}async function y(e){let{authRequest:{hostname:t,derivationOrigin:i}={hostname:""}}=e;if(console.debug("checkIsIframeAllowed",{hostname:t,derivationOrigin:i}),!t)throw new Error("checkIsIframeAllowed hostname cannot be empty");const{isIFrameAllowed:n,domain:a}=await(0,h.UM)(i||t);return console.debug("checkIsIframeAllowed",{isIFrameAllowed:n,domain:a}),n}},53131:(e,t,i)=>{i.d(t,{Z:()=>h});var n=i(53844),a=i(40751),o=i(78765),r=i(6732),s=i(1373),c=i(23439),l=i(30365);var u=i(71287),d=i(71516);const h=(0,n.C)({tsTypes:{},schema:{events:{},context:{}},id:"TrustDeviceMachine",initial:"CheckCapability",states:{CheckCapability:{initial:"Trusted",states:{Trusted:{invoke:{src:"isDeviceRegistered",id:"isDeviceRegistered",onDone:[{cond:"bool",target:"#TrustDeviceMachine.End"},{target:"WebAuthnPlatformCapability"}]}},WebAuthnPlatformCapability:{invoke:{src:"fetchWebAuthnPlatformCapability",id:"fetchWebAuthnPlatformCapability",onDone:[{cond:"bool",target:"#TrustDeviceMachine.Select"},{target:"SecurityKey"}]}},SecurityKey:{invoke:{src:"hasSecurityKey",id:"hasSecurityKey",onDone:[{cond:"bool",target:"#TrustDeviceMachine.End"},{target:"#TrustDeviceMachine.Select"}]}},End:{type:"final"}}},Select:{on:{TRUST:{target:"CheckIframeSelect"},DONT_TRUST:{target:"End"},END:{target:"End"}}},CheckIframeSelect:{invoke:{src:"checkIframeSelect",id:"checkIframeSelect",onDone:[{cond:"bool",target:"IframeSelect"},{target:"Register"}]}},IframeSelect:{invoke:{src:"getIframeWebauthn",id:"getIframeWebauthn",onDone:"End"}},Register:{invoke:{src:"fetchWebAuthnPlatformCapability",id:"fetchWebAuthnPlatformCapability",onDone:[{cond:"bool",target:"RegisterDeviceWithWebAuthn"},{target:"RegisterDeviceWithSecurityKey"}]}},RegisterDeviceWithWebAuthn:{invoke:{src:"registerDeviceWithWebAuthn",id:"registerDeviceWithWebAuthn",onDone:[{target:"End"}],onError:[{target:"RegisterDeviceWithWebAuthn",internal:!1}]}},RegisterDeviceWithSecurityKey:{invoke:{src:"registerDeviceWithSecurityKey",id:"regsiterWithSecurityKey",onDone:[{target:"End"}]}},End:{type:"final"}}},{services:{isDeviceRegistered:async()=>(0,d.ku)(),fetchWebAuthnPlatformCapability:u.th,registerDeviceWithWebAuthn:r.Lf,registerDeviceWithSecurityKey:r.cI,hasSecurityKey:s.Gt,checkIframeSelect:async e=>{var t;return null!==(t=null===e||void 0===e?void 0:e.isIframe)&&void 0!==t&&t},getIframeWebauthn:async()=>{const e=await(0,c.In)(),t=await(0,l.Tw)(BigInt(e.anchor)),i=window.open(`${NFID_PROVIDER_URL}/iframe/trust-device`,"iframeTrust",`toolbar=0,location=0,menubar=0,width=390,height=500,\n    left=${(window.screen.width-390)/2},\n    top=${(window.screen.height-490)/2}`);if(i)return new Promise((n=>{null===i||void 0===i||i.addEventListener("message",(async l=>{if(null!==l&&void 0!==l&&l.data){if("ready"in l.data)return null===i||void 0===i?void 0:i.postMessage({devices:t});if("isDeviceTrusted"in(null===l||void 0===l?void 0:l.data)){var u;if("identity"in(null===l||void 0===l?void 0:l.data)&&"isWebAuthN"in(null===l||void 0===l?void 0:l.data))await(async(e,t)=>{const i=await(0,c.In)(),n=a.bP.fromJSON(e);try{await(0,r.j)(n,BigInt(i.anchor),!t)}catch(l){if(console.error("registerDeviceWithSecurityKey",{message:l.message}),!s.Kn.includes(l.message))throw l;console.debug("registerDeviceWithSecurityKey","device already registered")}})(l.data.identity,null===l||void 0===l||null===(u=l.data)||void 0===u?void 0:u.isWebAuthN);l.data.isDeviceTrusted&&(0,o.RG)(e),n(!1)}}}))}))}},guards:{bool:(e,t)=>t.data}})},67142:(e,t,i)=>{i.d(t,{J:()=>s});var n=i(18414),a=(i(87273),i(82898)),o=i(93302),r=i(33693);const s=e=>{let{isLoading:t,deviceName:i,platformAuthenticatorName:n,isPlatformAuthenticatorAvailable:s,loadingMessage:l,onLogin:u,onRegisterPlatformDevice:d,onRegisterSecurityDevice:h}=e;return(0,r.jsxs)(o.B,{isLoading:t,loadingMessage:l,children:[(0,r.jsx)(a.x1,{title:"Sign in faster on this device",subTitle:s?`Trust this ${i}? You can quickly and securely sign in next time using this device's ${n}.`:"You can quickly and securely sign in next time with a security key if you register one now."}),(0,r.jsx)("div",{className:"flex flex-col w-full space-y-1 mt-7",children:s?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(c,{id:"trust-this-device",title:"Trust this device",subtitle:`Use ${n} to continue`,handler:d}),(0,r.jsx)(c,{id:"just-log-me-in",title:"Don\u2019t trust this device",subtitle:"This device is public or someone else\u2019s",handler:u})]}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(c,{id:"register-my-security-key",title:"Register my security key",subtitle:"Sign in faster with your security key",handler:h}),(0,r.jsx)(c,{id:"just-log-me-in",title:"Just log me in",subtitle:"I don\u2019t want to register a security key now",handler:u})]})})]})},c=e=>{let{title:t,subtitle:i,handler:a,id:o}=e;return(0,r.jsxs)("div",{id:o,className:(0,n.Z)("w-full py-[10px] px-4 border border-primaryButtonColor/30 rounded-md","hover:bg-primaryButtonColor/10 hover:border-primaryButtonColor/50 cursor-pointer transition-all"),onClick:a,children:[(0,r.jsx)("p",{className:"text-sm",children:t}),(0,r.jsx)("p",{className:"mt-0.5 text-xs text-secondary",children:i})]})}},75205:(e,t,i)=>{i.d(t,{Gr:()=>r,g_:()=>o});var n=i(20964),a=i.n(n);const o=()=>a().getParser(window.navigator.userAgent).getBrowser().name,r=e=>(/^(http|https):\/\//.test(e)||(e=`${window.location.protocol}//${e}`),new URL(e))}}]);
//# sourceMappingURL=75.cf5c9fef.chunk.js.map